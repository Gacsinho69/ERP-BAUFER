<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Template principal de cotización BAUFER -->
    <template id="report_saleorder_document_baufer" inherit_id="sale.report_saleorder_document">
        
        <!-- Reemplazar todo el header -->
        <xpath expr="//div[hasclass('page')]/div[1]" position="replace">
            
            <!-- Header con logo y datos de empresa -->
            <div class="baufer-header">
                <div class="row">
                    <div class="col-6">
                        <img src="/baufer_sale_report/static/src/img/baufer_logo.png" 
                             alt="BAUFER" 
                             style="max-height: 80px;"/>
                    </div>
                    <div class="col-6 text-right baufer-company-info">
                        <strong>Inversiones Séneca SpA.</strong><br/>
                        <strong>Rut:</strong> 77.912.335-9<br/>
                        El Bosque Norte 200, Oficina 701, Providencia.<br/>
                        <span style="color: #FF6200;">contacto@baufer.cl</span>
                    </div>
                </div>
            </div>
            
            <div class="baufer-separator"/>
            
            <!-- Información del presupuesto y cliente -->
            <div class="baufer-info-grid">
                <div class="row">
                    <div class="col-6">
                        <table class="baufer-info-table">
                            <tr>
                                <td><strong>Fecha:</strong></td>
                                <td><span t-field="doc.date_order" t-options='{"widget": "date"}'/></td>
                            </tr>
                            <tr>
                                <td><strong>Presupuesto:</strong></td>
                                <td><span t-field="doc.name"/></td>
                            </tr>
                            <tr>
                                <td><strong>Cliente:</strong></td>
                                <td><span t-field="doc.partner_id.name"/></td>
                            </tr>
                            <tr>
                                <td><strong>Dirección:</strong></td>
                                <td><span t-field="doc.partner_id.street"/></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="col-6">
                        <table class="baufer-info-table">
                            <tr t-if="doc.customer_branch">
                                <td><strong>Sucursal cliente:</strong></td>
                                <td><span t-field="doc.customer_branch"/></td>
                            </tr>
                            <tr t-if="doc.customer_contact_name">
                                <td><strong>Contacto:</strong></td>
                                <td><span t-field="doc.customer_contact_name"/></td>
                            </tr>
                            <tr t-if="doc.customer_contact_email">
                                <td><strong>Correo:</strong></td>
                                <td><span t-field="doc.customer_contact_email"/></td>
                            </tr>
                            <tr t-if="doc.customer_contact_phone">
                                <td><strong>Teléfono:</strong></td>
                                <td><span t-field="doc.customer_contact_phone"/></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Información del vehículo -->
                <div class="row" t-if="doc.vehicle_brand or doc.vehicle_model">
                    <div class="col-12">
                        <div class="baufer-separator-small"/>
                        <table class="baufer-info-table">
                            <tr>
                                <td style="width: 15%;"><strong>Marca:</strong></td>
                                <td style="width: 35%;"><span t-field="doc.vehicle_brand"/></td>
                                <td style="width: 15%;"><strong>Modelo:</strong></td>
                                <td style="width: 35%;"><span t-field="doc.vehicle_model"/></td>
                            </tr>
                            <tr>
                                <td><strong>Patente:</strong></td>
                                <td><span t-field="doc.vehicle_plate"/></td>
                                <td><strong>VIN:</strong></td>
                                <td><span t-field="doc.vehicle_vin"/></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="baufer-separator"/>
            
            <!-- Título de sección -->
            <h4 class="baufer-section-title">I. Repuestos, partes o piezas</h4>
        </xpath>
        
        <!-- Reemplazar la tabla de productos -->
        <xpath expr="//table[@name='sale_order_line_table']" position="replace">
            <table class="table table-sm baufer-products-table" name="sale_order_line_table">
                <thead class="baufer-table-header">
                    <tr>
                        <th class="text-center">Cant</th>
                        <th class="text-left">Código</th>
                        <th class="text-left">Descripción</th>
                        <th class="text-center">Origen</th>
                        <th class="text-right">Unitario</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-foreach="doc.order_line" t-as="line">
                        <tr>
                            <td class="text-center"><span t-field="line.product_uom_qty"/></td>
                            <td><span t-field="line.product_code"/></td>
                            <td><span t-field="line.name"/></td>
                            <td class="text-center"><span t-field="line.origin_location"/></td>
                            <td class="text-right">
                                $<span t-field="line.price_unit" t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                            </td>
                            <td class="text-right">
                                $<span t-field="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                            </td>
                        </tr>
                    </t>
                </tbody>
            </table>
        </xpath>
        
        <!-- Reemplazar el total -->
        <xpath expr="//div[@id='total']" position="replace">
            <div id="total" class="baufer-totals">
                <div class="row">
                    <div class="col-8"/>
                    <div class="col-4">
                        <table class="table table-sm baufer-totals-table">
                            <tr t-if="doc.amount_total != doc.amount_untaxed">
                                <td class="text-right"><strong>Descuento:</strong></td>
                                <td class="text-right baufer-discount">
                                    $ <span t-esc="'{:,.0f}'.format(sum(line.product_uom_qty * line.price_unit * (line.discount/100) for line in doc.order_line))"/>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-right"><strong>Sub-total:</strong></td>
                                <td class="text-right">
                                    $<span t-field="doc.amount_untaxed" t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                </td>
                            </tr>
                            <tr t-if="doc.amount_tax">
                                <td class="text-right"><strong>IVA (19%):</strong></td>
                                <td class="text-right">
                                    $<span t-field="doc.amount_tax" t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                </td>
                            </tr>
                            <tr class="baufer-total-row">
                                <td class="text-right"><strong>TOTAL:</strong></td>
                                <td class="text-right">
                                    <strong>$<span t-field="doc.amount_total" t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/></strong>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </xpath>
        
    </template>
    
</odoo>

